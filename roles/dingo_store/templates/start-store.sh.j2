#!/bin/bash

mydir="${BASH_SOURCE%/*}"
if [[ ! -d "$mydir" ]]; then mydir="$PWD"; fi
. $mydir/shflags


DEFINE_string role 'store' 'server role'
DEFINE_boolean clean_db 1 'clean db'
DEFINE_boolean clean_raft 1 'clean raft'
DEFINE_boolean clean_log 0 'clean log'
DEFINE_boolean replace_conf 0 'replace conf'

# parse the command-line
FLAGS "$@" || exit 1
eval set -- "${FLAGS_ARGV}"


BASE_DIR=$(dirname $(cd $(dirname $0); pwd))
DIST_DIR=$BASE_DIR/dist

SERVER_HOST={{ inventory_hostname | default(127.0.0.1) }}
RAFT_HOST={{ inventory_hostname | default(127.0.0.1) }}
COOR_SRV_PEERS={{ dingo_store_store_exchange_connection_list }}
STORE_NUM={{ hostvars[inventory_hostname]['store_num'] | default(1) }}
RAFT_START_PORT={{ RAFT_START_PORT | default(20101) }}
SERVER_START_PORT={{ SERVER_START_PORT | default(20001) }}


if [ ! -d "$DIST_DIR" ]; then
  mkdir "$DIST_DIR"
fi


function deploy_store() {
  role=$1
  srcpath=$2
  dstpath=$3
  server_port=$4
  raft_port=$5
  instance_id=$6
  coor_srv_peers=$7
  coor_raft_peers=$8

  echo "server ${dstpath}"

  if [ ! -d "$dstpath" ]; then
    mkdir "$dstpath"
  fi

  if [ ! -d "$dstpath/bin" ]; then
    mkdir "$dstpath/bin"
  fi
  if [ ! -d "$dstpath/conf" ]; then
    mkdir "$dstpath/conf"
  fi
  if [ ! -d "$dstpath/log" ]; then
    mkdir "$dstpath/log"
  fi
  if [ ! -d "$dstpath/data" ]; then
    mkdir "$dstpath/data"
  fi
  if [ ! -d "$dstpath/data/store" ]; then
    mkdir "$dstpath/data/store"
  fi
  if [ ! -d "$dstpath/data/store/raft" ]; then
    mkdir "$dstpath/data/store/raft"
  fi
  if [ ! -d "$dstpath/data/store/db" ]; then
    mkdir "$dstpath/data/store/db"
  fi

  cp $srcpath/build/bin/dingodb_server $dstpath/bin/
  if [ "${FLAGS_replace_conf}" == "0" ]; then
    cp $srcpath/conf/${role}.template.yaml $dstpath/conf/${role}.yaml

    sed  -i 's,\$INSTANCE_ID\$,'"$instance_id"',g'          $dstpath/conf/${role}.yaml
    sed  -i 's,\$SERVER_HOST\$,'"$SERVER_HOST"',g'          $dstpath/conf/${role}.yaml
    sed  -i 's,\$SERVER_PORT\$,'"$server_port"',g'          $dstpath/conf/${role}.yaml
    sed  -i 's,\$RAFT_HOST\$,'"$RAFT_HOST"',g'              $dstpath/conf/${role}.yaml
    sed  -i 's,\$RAFT_PORT\$,'"$raft_port"',g'              $dstpath/conf/${role}.yaml
    sed  -i 's,\$BASE_PATH\$,'"$dstpath"',g'                $dstpath/conf/${role}.yaml

    sed  -i 's|\$COORDINATOR_SERVICE_PEERS\$|'"$coor_srv_peers"'|g'    $dstpath/conf/${role}.yaml
    sed  -i 's|\$COORDINATOR_RAFT_PEERS\$|'"$coor_raft_peers"'|g'  $dstpath/conf/${role}.yaml
  fi

  if [ "${FLAGS_clean_db}" == "0" ]; then
    rm -rf $dstpath/data/store/db/*
  fi
  if [ "${FLAGS_clean_raft}" == "0" ]; then
    rm -rf $dstpath/data/store/raft/*
  fi
  if [ "${FLAGS_clean_log}" == "0" ]; then
    rm -rf $dstpath/log/*
  fi
}

deploy() {
  for i in $(seq 1 $STORE_NUM)
  do
    START_ID={{ groups['coordinator'].index(inventory_hostname) * 100 }}
    INSTANCE_START_ID=`expr 1000 + $i + $START_ID`
    N_SERVER_START_PORT=`expr $SERVER_START_PORT + $i - 1`
    N_RAFT_START_PORT=`expr $RAFT_START_PORT + $i - 1`
    program_dir=$BASE_DIR/dist/${FLAGS_role}${i}
    deploy_store ${FLAGS_role} $BASE_DIR $program_dir  $N_SERVER_START_PORT $N_RAFT_START_PORT $INSTANCE_START_ID ${COOR_SRV_PEERS} ${COOR_RAFT_PEERS:-fail}
  done
}


function start_program() {
  role=$1
  root_dir=$2
  echo "start server: ${root_dir}"

  cd ${root_dir}

   nohup ${root_dir}/bin/dingodb_server --role ${role}  --conf ./conf/${role}.yaml 2>&1 >./log/out &
   #./bin/dingodb_server --role ${role}  --conf ./conf/${role}.yaml
}



start() {
  #FLAGS_role=${FLAGS_role}
  for i in $(seq 1 $STORE_NUM)
  do
    program_dir=$BASE_DIR/dist/${FLAGS_role}${i}
    # clean log
    rm -f ${program_dir}/log/*
    start_program ${FLAGS_role} ${program_dir}
  done    
}




clean() 
{
  rm -rf ../dist/store*
  sleep 1
  echo "rm -rf all cluster files"
}




stop() 
{
   k_pid=$(ps -fu {{ dingo_user }} | grep "dingodb_server --role store"   |grep -v grep|awk '{printf $2 "\n"}')
   for i in $k_pid
   do
   echo $i 
   $(kill -9 $i)
   done
}

usage()
{
        echo "Usage: $0 [clean|deploy|start|stop|restart|cleanstart]"
}

if [ $# -lt 1 ];then
        usage
        exit
fi

if [ "$1" = "deploy" ];then
        deploy
	
elif [ "$1" = "clean" ];then
        stop
	clean

elif [ "$1" = "start" ];then
        start

elif [ "$1" = "stop" ];then
        stop

elif [ "$1" = "restart" ];then
        stop
        start

elif [ "$1" = "cleanstart" ];then
        stop
        clean
        deploy
        start

else
        usage
fi
